# 6.824_P18-P20_DeCentralize

6.824最后三节课讨论的是去中心化系统。

前面所讨论的分布式系统都是建立在系统中没有恶意节点的基础上，在去中心化系统中，系统更加开放，需要对参与系统中的节点进行认证、防止恶意的数据篡改。

## P18_证书透明化

在早期的互联没有证书的时候，存在一种中间人攻击。当客户端与服务器进行通信时，中间人伪装成服务器截取了客户端数据，然后转发给服务器，然后截取服务器返回数据，再转发给客户端，从而获取了通信双向数据，进而实施恶意行为。

证书以及ssh\tls\https从一定程度上解决了这一问题，这里面主要采用了非对称加密。客户端使用服务器的公钥对数据进行加密，只有拥有私钥的服务器才能解密数据，进行正常通信，从而既可以保护通信内容，又能够验证服务器端身份。

但是使用证书仍然存在问题，比如非谷歌的公司去申请了谷歌的证书、证书签发机构存在恶意或错误行为等，导致证书有些时候不那么可信。

证书透明化就是为了审计这种问题而设计的。证书透明为证书系统增加了三个新的功能：证书日志、证书监控、证书审计。

简单来说是三件事：第一所有被使用的证书都应该在日志中，第二用户会审计证书是否在日志中，不在日志中的证书不会被使用，第三合法证书拥有者会监控日志中的证书是否合法。关键在于一是如何确保日志不会被篡改，二是如何检查日志是否在日志中。

证书日志记录了每一次证书申请，包含三个重要特征：只能追加、加密确认、公开审计。日志服务器定期的将新写入的日志进行哈希，并与之前的结果进行哈希运算，生成签名树头，整个运算的过程形成了默克哈希树。通过加密确认来确保1.日志一致性：新日志包含旧日志的全部内容（提供旧日志的哈系节点和到新日志的哈系节点所有路径上的节点，进行哈系计算），保证内容没有被修改;2.证书审计：某条日志是否存在于日志中（提供日志节点到签名树头路径上所有节点，进行哈系计算）。

各大运营商（如谷歌）可以周期地从日志服务器获取日志记录，查看是否有自己名下的非法证书。

浏览器一是会进行证书审计，确认证书是否在日志中，而是也会保存签名树头，查验新日志是否包含了就日志的全部内容（是否进行了日志篡改）

## P19_比特币

比特币是一种广为人知的去中心化的分布式系统。

假设网络中有一些比特币，每一个比特币都属于它的拥有者。每个比特币有一些列的交易记录，最后一条交易记录反映了它当前的拥有者。

没一条交易记录包含：新的拥有者的公钥，之前所有交易记录的Hash，上一位拥有者私钥签名。

因为其他人没有对应的私钥，所以其他人无法使用该交易所记录的比特比。

双花：同一枚比特币被Y支付给Z后又支付给Q。

如果Z和Q不能获取全部的交易记录或者不能保证交易记录的顺序，则可能存在双花。

为了避免双花，我们需要：公布全部交易记录，确保每个节点看到相同的交易顺序。

之所以不能采用向Raft那样的多数达成共识即认为交易完成的原因在于，对于开放的比特币网络无法确定到底多少参与者，如何区别身份。

比特比采用区块链来实现：区块链包含所有比特币的所有交易记录，并且通过网络互联，新的区块通过转发的方式推送到所有节点，交易也被推送到所有节点。每个区块包含前一个区块的hash，一些交易记录，一个随机数，时间戳。区块链网络中的每一个节点，从已知的最大区块开始，计算这一区块的hash，收集新的交易记录，不停的生成随机数并计算整个区块的hash（挖矿），该随机数使得整个区块的hash值包含N个前导0，则这是该节点可以创建一个区块，创建区块的节点可以获取创建该区块的比特币奖励（这也是比特币的原始由来）。那么就存在一种情况，可能同时有多个节点都算出了下一个节点，此时区块链不予处理，链发生了分支，但是随着时间推移总有一个分支会长于其他分支，而越长的分支越能得到其他节点的认同（节点都是在最长链的基础上继续工作），从而便的更长，区块链永远只有最长的链（汇聚了最多算力）能够继续延续。所以暂时的双花是可能的，但随着一个分支的胜出，双花就不存在了。因此对于一笔交易需要等待一定的延时才能确认。

## P20_Blockstack